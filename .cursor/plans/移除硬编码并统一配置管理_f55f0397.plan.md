---
name: 移除硬编码并统一配置管理
overview: 整理 inference/vla 目录下的推理脚本，移除所有硬编码路径和配置值，建立统一的配置管理系统（环境变量 + 配置文件），使代码更适合开源。
todos:
  - id: create_config_module
    content: 创建 inference/vla/config.py 配置管理模块，支持环境变量和 YAML 配置文件加载
    status: completed
  - id: create_config_template
    content: 创建 inference/vla/config.yaml.example 配置文件模板，包含所有可配置项和注释
    status: completed
  - id: refactor_qformer_script
    content: 重构 inference_action_navsim_qformer_vava.py，移除硬编码，使用配置模块
    status: completed
    dependencies:
      - create_config_module
  - id: refactor_pi0_script
    content: 重构 inference_action_navsim_pi0_vava.py，移除硬编码，使用配置模块
    status: completed
    dependencies:
      - create_config_module
  - id: refactor_ar_script
    content: 重构 inference_action_navsim_ar_vava.py，移除硬编码，使用配置模块
    status: completed
    dependencies:
      - create_config_module
  - id: update_shell_scripts
    content: 更新 infer_navsim_qformer.sh 和 run_emu_vla_navsim_metric_others.sh，使用环境变量
    status: completed
  - id: create_readme
    content: 创建 inference/vla/README.md 文档，说明配置和使用方法
    status: completed
    dependencies:
      - create_config_module
      - create_config_template
---

# 整理 inference/vla 目录代码，移除硬编码

## 问题分析

当前代码中存在的主要硬编码问题：

1. **项目根路径硬编码**：不同文件中使用了不同的绝对路径

- `inference_action_navsim_qformer_vava.py`: `/mnt/nvme0n1p1/yingyan.li/repo/DriveVLA-W0`
- `inference_action_navsim_pi0_vava.py`: `/mnt/vdb1/shuyao.shang/VLA_Emu_Huawei`
- `inference_action_navsim_ar_vava.py`: `/sda1/shuyao_shang/VLA_Emu_Huawei`

2. **模型和配置文件路径硬编码**：

- `action_tokenizer_path`: `/mnt/vdb1/shuyao.shang/VLA_Emu_Huawei/pretrained_models/fast`
- `vlm_model_path_for_tokenizer`: `/mnt/vdb1/shuyao.shang/VLA_Emu_Huawei/logs/train_nuplan_6va_v0.2_multi_node`
- `norm_stats_path`: `/mnt/vdb1/shuyao.shang/VLA_Emu_Huawei/configs/normalizer_navsim_trainval/norm_stats.json`

3. **Shell脚本中的硬编码**：

- Python路径、PYTHONPATH 等

4. **配置值分散**：各种参数（batch_size, num_workers等）分散在代码中

## 解决方案

### 1. 创建配置管理模块

创建 `inference/vla/config.py` 模块，提供统一的配置加载功能：

- 支持从环境变量读取配置
- 支持从 YAML 配置文件读取
- 提供合理的默认值
- 自动检测项目根目录（基于脚本位置）

### 2. 创建配置文件模板

创建 `inference/vla/config.yaml.example` 作为配置模板，包含：

- 项目根路径
- 模型路径配置
- 数据路径配置
- 默认参数配置

### 3. 重构推理脚本

重构以下文件，移除硬编码：

- `inference_action_navsim_qformer_vava.py`
- `inference_action_navsim_pi0_vava.py`
- `inference_action_navsim_ar_vava.py`
- `inference_action_navsim_with_previous_action_last_VAVA.py`（如果存在）

主要改动：

- 使用配置模块加载路径和参数
- 通过命令行参数或环境变量覆盖配置
- 统一路径处理逻辑

### 4. 更新 Shell 脚本

更新 `infer_navsim_qformer.sh` 和 `run_emu_vla_navsim_metric_others.sh`：

- 使用环境变量设置路径
- 移除硬编码的 Python 路径
- 添加配置说明注释

### 5. 创建 README

创建 `inference/vla/README.md` 说明：

- 如何设置环境变量
- 如何使用配置文件
- 如何运行推理脚本

## 实施步骤

1. **创建配置管理模块** (`inference/vla/config.py`)

- 实现配置加载逻辑
- 支持环境变量和配置文件
- 自动检测项目根目录

2. **创建配置模板** (`inference/vla/config.yaml.example`)

- 定义所有可配置项
- 添加注释说明

3. **重构推理脚本**

- 替换硬编码路径为配置加载
- 统一代码结构
- 保持向后兼容（通过命令行参数）

4. **更新 Shell 脚本**

- 使用环境变量
- 添加使用说明

5. **创建文档**

- README.md 说明配置和使用方法

## 文件清单

需要创建的文件：

- `inference/vla/config.py` - 配置管理模块
- `inference/vla/config.yaml.example` - 配置模板
- `inference/vla/README.md` - 使用文档

需要修改的文件：